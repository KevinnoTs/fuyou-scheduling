{% extends "layouts/base.html" %}

{% block title %}添加医生 - 医院排班管理系统{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-person-plus-fill"></i> 添加医生</h5>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data" id="doctorForm">
                    <!-- 基本信息部分 -->
                    <div class="mb-4">

                        <!-- 头像上传 -->
                        <div class="text-center mb-4">
                            <div class="avatar-upload">
                                <label for="avatarInput" class="avatar-label">
                                    <img id="avatarPreview"
                                         src="{{ url_for('static', filename='images/default_avatar.jpg') }}"
                                         alt="头像预览"
                                         class="rounded-circle avatar-preview">
                                    <div class="avatar-overlay">
                                        <i class="bi bi-camera"></i>
                                        <small>点击上传头像</small>
                                    </div>
                                </label>
                                <input type="file" name="avatar" id="avatarInput" class="d-none" accept="image/*">
                                <input type="hidden" name="croppedAvatar" id="croppedAvatar" value="">
                            </div>
                            <small class="text-muted">
                                支持 JPG、PNG 格式，最大 5MB<br>
                                未上传头像时将根据性别自动选择默认头像
                            </small>
                        </div>

                        <!-- 姓名 -->
                        <div class="mb-3">
                            <label for="name" class="field-label">
                                <i class="bi bi-person"></i> 姓名 <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control form-control-sm" id="name" name="name" required
                                   value="{{ name or '' }}" placeholder="请输入医生姓名" style="max-width: 150px;">
                        </div>

                        <!-- 职称 -->
                        <div class="mb-3">
                            <label for="title" class="field-label">
                                <i class="bi bi-award"></i> 职称 <span class="text-danger">*</span>
                            </label>
                            <select class="form-select form-select-sm" id="title" name="title" required style="max-width: 150px;">
                                <option value="主任医师">主任医师</option>
                                <option value="副主任医师">副主任医师</option>
                                <option value="医师">医师</option>
                                <option value="打字员" selected>打字员</option>
                            </select>
                        </div>

                        <!-- 在职状态 -->
                        <div class="mb-3">
                            <label for="status" class="field-label">
                                <i class="bi bi-person-check"></i> 在职状态 <span class="text-danger">*</span>
                            </label>
                            <select class="form-select form-select-sm" id="status" name="status" required style="max-width: 150px;">
                                <option value="在职" selected>在职</option>
                                <option value="离职">离职</option>
                            </select>
                        </div>

                        <!-- 性别 -->
                        <div class="mb-3">
                            <label class="field-label">
                                <i class="bi bi-gender-ambiguous"></i> 性别 <span class="text-danger">*</span>
                            </label>
                            <div class="row">
                                <div class="col-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="gender" id="gender_male"
                                               value="男" required checked>
                                        <label class="form-check-label" for="gender_male">
                                            <i class="bi bi-gender-male text-primary"></i> 男
                                        </label>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="gender" id="gender_female"
                                               value="女" required>
                                        <label class="form-check-label" for="gender_female">
                                            <i class="bi bi-gender-female text-danger"></i> 女
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 擅长方向 -->
                        <div class="mb-3">
                            <label class="field-label">
                                <i class="bi bi-star"></i> 擅长方向 <span class="text-danger">*</span>
                            </label>
                            <div class="row">
                                {% for spec in specialties %}
                                    <div class="col-6 col-md-3 mb-2">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="specialties"
                                                   value="{{ spec.name }}" id="specialty_{{ loop.index }}">
                                            <label class="form-check-label" for="specialty_{{ loop.index }}">
                                                <span class="badge bg-secondary">{{ spec.name }}</span>
                                            </label>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            <small class="form-text text-muted">可以选择多个擅长方向，不区分优先级</small>
                        </div>
                    </div>

                    <!-- 年假信息部分 -->
                        <div class="mb-3">
                            <label for="annual_leave_days" class="field-label">
                                <i class="bi bi-calendar-check"></i> 每年年假天数
                            </label>
                            <input type="number" class="form-control form-control-sm" id="annual_leave_days" name="annual_leave_days"
                                       value="{{ annual_leave_days or 0 }}" min="0" max="365"
                                       style="max-width: 150px;" placeholder="天数">
                        </div>

                        <!-- 已休年假天数部分 -->
                        <div class="mb-3" id="usedLeaveSection" style="display: none;">
                            <label for="used_leave_days" class="field-label">
                                <i class="bi bi-calendar-minus"></i> 已休年假天数
                                <small class="text-muted">(不超过每年年假天数)</small>
                            </label>
                            <input type="number" class="form-control form-control-sm" id="used_leave_days" name="used_leave_days"
                                       value="0" min="0" max="{{ annual_leave_days or 0 }}"
                                       style="max-width: 150px;" placeholder="已休天数">
                            <div class="form-text">
                                <span id="remainingDays">剩余：{{ annual_leave_days or 0 }}天</span>
                            </div>
                        </div>

                    <!-- 序号管理部分 - 仅超级管理员可见 -->
                    {% if current_user.is_super_admin %}
                    <div class="mb-3">
                        <label for="sequence" class="field-label">
                            <i class="bi bi-hash"></i> 显示序号
                        </label>
                        <input type="number" class="form-control form-control-sm" id="sequence" name="sequence"
                                   value="{{ sequence or 999 }}" min="1" max="9999"
                                   style="max-width: 150px;" placeholder="序号">
                    </div>
                    {% endif %}

                    <!-- 提交按钮 -->
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> 添加医生
                        </button>
                        <a href="{{ url_for('main.doctors') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> 返回列表
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 年假天数动态显示功能
    const annualLeaveInput = document.getElementById('annual_leave_days');
    const usedLeaveSection = document.getElementById('usedLeaveSection');
    const usedLeaveInput = document.getElementById('used_leave_days');
    const remainingDaysSpan = document.getElementById('remainingDays');

    // 初始显示/隐藏已休年假天数字段
    if (annualLeaveInput && annualLeaveInput.value && parseInt(annualLeaveInput.value) > 0) {
        // 只有当年假天数大于0时才显示已休天数字段
        usedLeaveSection.style.display = 'block';
        updateRemainingDays();
    } else {
        // 年假天数为0或空时，隐藏已休天数字段
        usedLeaveSection.style.display = 'none';
        // 确保已休天数字段的值为0
        if (usedLeaveInput) {
            usedLeaveInput.value = 0;
        }
    }

    // 在外部作用域声明变量，确保事件监听器可以共享
    let originalUsedDays = 0;
    let temporaryUsedDays = 0;

    // 只有当年假天数大于0时才保留原始的已休天数
    if (annualLeaveInput && annualLeaveInput.value && parseInt(annualLeaveInput.value) > 0) {
        originalUsedDays = parseInt(usedLeaveInput.value) || 0;
        temporaryUsedDays = originalUsedDays;
    }

    // 监听每年年假天数输入
    if (annualLeaveInput) {
        annualLeaveInput.addEventListener('input', function() {
            const newAnnualDays = parseInt(this.value) || 0;

            if (newAnnualDays > 0) {
                usedLeaveSection.style.display = 'block';

                if (usedLeaveInput) {
                    usedLeaveInput.max = newAnnualDays;

                    // 恢复原始数据，并根据新的年假天数调整
                    if (originalUsedDays <= newAnnualDays) {
                        // 如果原始已休天数小于等于新的年假天数，恢复原始值
                        temporaryUsedDays = originalUsedDays;
                        usedLeaveInput.value = originalUsedDays;
                    } else {
                        // 如果原始已休天数大于新的年假天数，调整为最大值
                        temporaryUsedDays = newAnnualDays;
                        usedLeaveInput.value = newAnnualDays;
                    }
                }
                updateRemainingDays();
            } else {
                // 年假天数为0时，隐藏字段但保留原始数据，临时显示为0
                usedLeaveSection.style.display = 'none';
                if (usedLeaveInput) {
                    usedLeaveInput.value = 0; // 临时显示为0
                }
                temporaryUsedDays = 0; // 临时值为0，但originalUsedDays保持不变
            }
        });
    }

    // 监听已休年假天数输入
    if (usedLeaveInput) {
        usedLeaveInput.addEventListener('input', function() {
            validateUsedLeave();
            updateRemainingDays();
            // 用户手动修改已休天数时，更新原始数据
            const annualDays = parseInt(annualLeaveInput.value) || 0;
            const newUsedDays = parseInt(this.value) || 0;

            if (annualDays > 0 && newUsedDays <= annualDays) {
                // 只有在年假天数大于0且输入值合理时，才更新原始数据
                originalUsedDays = newUsedDays;
                temporaryUsedDays = newUsedDays;
            }
        });
    }

    // 更新剩余天数显示
    function updateRemainingDays() {
        if (annualLeaveInput && usedLeaveInput && remainingDaysSpan) {
            const annualDays = parseInt(annualLeaveInput.value) || 0;
            const usedDays = parseInt(usedLeaveInput.value) || 0;
            const remaining = annualDays - usedDays;
            remainingDaysSpan.textContent = `剩余：${remaining}天`;

            // 根据剩余天数改变颜色
            if (remaining < 0) {
                remainingDaysSpan.style.color = '#dc3545'; // 红色
            } else if (remaining <= 3) {
                remainingDaysSpan.style.color = '#ffc107'; // 黄色
            } else {
                remainingDaysSpan.style.color = '#28a745'; // 绿色
            }
        }
    }

    // 验证已休年假天数
    function validateUsedLeave() {
        if (usedLeaveInput && annualLeaveInput) {
            const annualDays = parseInt(annualLeaveInput.value) || 0;
            const usedDays = parseInt(usedLeaveInput.value) || 0;

            // 清除之前的验证状态
            usedLeaveInput.classList.remove('is-valid', 'is-invalid');

            if (usedDays < 0) {
                usedLeaveInput.classList.add('is-invalid');
            } else if (usedDays > annualDays) {
                usedLeaveInput.classList.add('is-invalid');
            } else {
                usedLeaveInput.classList.add('is-valid');
            }
        }
    }

    // 头像预览功能
    const avatarInput = document.getElementById('avatarInput');
    const avatarPreview = document.getElementById('avatarPreview');
    let hasCustomAvatar = false; // 标记是否有自定义头像

    // 性别切换功能
    function updateDefaultAvatar(gender) {
        if (!hasCustomAvatar) {
            // 只有在没有自定义头像时才切换默认头像
            if (gender === '女') {
                avatarPreview.src = "{{ url_for('static', filename='images/default_female_avatar.jpg') }}";
            } else {
                avatarPreview.src = "{{ url_for('static', filename='images/default_male_avatar.jpg') }}";
            }
        }
    }

    // 监听性别选择变化
    document.querySelectorAll('input[name="gender"]').forEach(radio => {
        radio.addEventListener('change', function() {
            updateDefaultAvatar(this.value);
        });
    });

    // 头像上传处理
    avatarInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            // 检查文件大小
            if (file.size > 5 * 1024 * 1024) {
                alert('文件大小不能超过 5MB');
                e.target.value = '';
                return;
            }

            // 检查文件类型
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/bmp'];
            if (!allowedTypes.includes(file.type)) {
                alert('请选择有效的图片文件 (JPG、PNG、GIF、BMP)');
                e.target.value = '';
                return;
            }

            // 预览图片
            const reader = new FileReader();
            reader.onload = function(e) {
                avatarPreview.src = e.target.result;
                hasCustomAvatar = true; // 标记为有自定义头像
            };
            reader.readAsDataURL(file);
        } else {
            hasCustomAvatar = false; // 清空文件，重置标记
            // 根据当前性别选择恢复默认头像
            const currentGender = document.querySelector('input[name="gender"]:checked')?.value || '男';
            updateDefaultAvatar(currentGender);
        }
    });

    // 表单验证
    const form = document.getElementById('doctorForm');
    form.addEventListener('submit', function(e) {
        const name = document.getElementById('name').value.trim();
        const gender = document.querySelector('input[name="gender"]:checked');
        const specialtyCheckboxes = document.querySelectorAll('input[name="specialties"]:checked');
        const annualLeaveDays = document.getElementById('annual_leave_days').value;
        const usedLeaveDays = document.getElementById('used_leave_days').value;

        if (!name) {
            alert('请输入医生姓名');
            e.preventDefault();
            return;
        }

        if (!gender) {
            alert('请选择性别');
            e.preventDefault();
            return;
        }

        if (specialtyCheckboxes.length === 0) {
            alert('请至少选择一个擅长方向');
            e.preventDefault();
            return;
        }

        if (annualLeaveDays < 0 || annualLeaveDays > 365) {
            alert('年假天数必须在 0-365 之间');
            e.preventDefault();
            return;
        }

        // 验证已休年假天数不能超过每年年假天数（使用当前显示的值进行验证）
        if (usedLeaveDays && parseInt(usedLeaveDays) > parseInt(annualLeaveDays)) {
            alert('已休年假天数不能超过每年年假天数');
            e.preventDefault();
            document.getElementById('used_leave_days').focus();
            return;
        }

        // 如果年假天数小于已使用天数，给出警告（使用当前显示的已休天数）
        if (parseInt(annualLeaveDays) < parseInt(usedLeaveDays || 0)) {
            if (!confirm(`警告：年假天数(${annualLeaveDays}天)小于已使用天数(${usedLeaveDays}天)，确定要继续吗？`)) {
                e.preventDefault();
                return;
            }
        }
    });
});
</script>
{% endblock %}