{% extends "layouts/base.html" %}

{% block title %}{{ doctor.name }} - 医生详情 - 妇幼排班管理系统{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 页面头部 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
            <i class="bi bi-person-badge-fill text-secondary"></i>
            {{ doctor.name }} - 医生详情
        </h1>
        <div>
            <!-- 检查编辑权限 -->
            {% if current_user.is_authenticated and (current_user.is_admin or current_user.is_super_admin) %}
                <!-- 管理员和超级管理员可以编辑所有信息 -->
                <a href="{{ url_for('main.edit_doctor', doctor_id=doctor.id) }}" class="btn btn-warning text-white">
                    <i class="bi bi-pencil-square"></i> 编辑信息
                </a>
            {% elif current_user.is_authenticated and current_user.associated_doctor_id == doctor.id %}
                <!-- 关联用户可以编辑头像 -->
                <a href="{{ url_for('main.edit_doctor', doctor_id=doctor.id) }}" class="btn btn-warning text-white">
                    <i class="bi bi-pencil-square"></i> 编辑头像
                </a>
            {% endif %}
            <a href="{{ url_for('main.doctors') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> 返回列表
            </a>
        </div>
    </div>

    <div class="row">
        <!-- 医生信息卡片 -->
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="row align-items-center">
                        <!-- 头像区域 -->
                        <div class="col-md-3 text-center">
                            <div class="position-relative d-inline-block">
                                <img src="{{ doctor.get_avatar_url() }}"
                                     alt="{{ doctor.name }}"
                                     class="rounded-circle img-fluid"
                                     style="width: 180px; height: 180px; object-fit: cover;">
                                <div class="position-absolute bottom-0 end-0">
                                    <span class="badge {% if doctor.gender == '男' %}bg-primary{% else %}bg-danger{% endif %} fs-6">
                                        {% if doctor.gender == '男' %}男{% else %}女{% endif %}
                                    </span>
                                </div>
                            </div>
                            <h3 class="mt-3 mb-1">{{ doctor.name }}</h3>
                            <div class="mb-2">
                                <span class="badge {% if (doctor.status or '在职') == '在职' %}bg-success{% else %}bg-secondary{% endif %} me-2">
                                    {{ doctor.status or '在职' }}
                                </span>
                                <span class="badge bg-info">
                                    {{ doctor.title or '打字员' }}
                                </span>
                            </div>

                                 </div>

                        <!-- 信息区域 -->
                        <div class="col-md-9">
                            <div class="row g-4">
                                <!-- 擅长方向 -->
                                <div class="col-md-6">
                                    <label class="field-label">擅长方向</label>
                                    <div>
                                        {% for specialty in doctor.get_specialties_list() %}
                                            <span class="badge bg-secondary me-1 mb-1">{{ specialty }}</span>
                                        {% endfor %}
                                        {% if not doctor.get_specialties_list() %}
                                            <span class="text-muted">未设置擅长方向</span>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- 年假状态 - 仅特定用户可见 -->
                                {% if current_user.is_authenticated and (current_user.is_admin or current_user.is_super_admin or current_user.associated_doctor_id == doctor.id) %}
                                <div class="col-md-3">
                                    <label class="field-label">年假状态</label>
                                    <div>
                                        {% set remaining = doctor.annual_leave_days - doctor.used_leave_days %}
                                        <div class="progress position-relative" style="height: 25px;">
                                            {% if doctor.annual_leave_days > 0 %}
                                            <div class="progress-bar {% if remaining > 0 %}bg-success{% else %}bg-danger{% endif %}"
                                                 role="progressbar"
                                                 style="width: {{ (doctor.used_leave_days / doctor.annual_leave_days * 100) }}%">
                                            </div>
                                            {% else %}
                                            <div class="progress-bar bg-secondary" style="width: 0%"></div>
                                            {% endif %}
                                            <span class="position-absolute w-100 text-center text-dark fw-bold" style="line-height: 25px; z-index: 10;">
                                                {% if doctor.annual_leave_days > 0 %}
                                                    {{ doctor.used_leave_days }}/{{ doctor.annual_leave_days }}天
                                                {% else %}
                                                    无年假
                                                {% endif %}
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <!-- 剩余年假 - 仅特定用户可见 -->
                                <div class="col-md-3">
                                    <label class="field-label">剩余年假</label>
                                    <div>
                                        {% set remaining = doctor.annual_leave_days - doctor.used_leave_days %}
                                        <div class="progress position-relative" style="height: 25px;">
                                            {% if doctor.annual_leave_days > 0 %}
                                            <div class="progress-bar {% if remaining > 0 %}bg-success{% else %}bg-danger{% endif %}"
                                                 role="progressbar"
                                                 style="width: {{ (remaining / doctor.annual_leave_days * 100) if doctor.annual_leave_days > 0 else 0 }}%">
                                            </div>
                                            {% else %}
                                            <div class="progress-bar bg-secondary" style="width: 0%"></div>
                                            {% endif %}
                                            <span class="position-absolute w-100 text-center text-dark fw-bold" style="line-height: 25px; z-index: 10;">
                                                {% if doctor.annual_leave_days > 0 %}
                                                    {% if remaining > 0 %}
                                                    剩余：{{ remaining }}天
                                                    {% else %}
                                                    剩余：0天
                                                    {% endif %}
                                                {% else %}
                                                    无年假
                                                {% endif %}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- 统计信息 -->
                                <div class="col-12">
                                    <div class="row text-center">
                                        <div class="col-md-3">
                                            <div class="p-3">
                                                <i class="bi bi-calendar-check display-6 text-primary"></i>
                                                <h6 class="mt-2">本月排班</h6>
                                                <p class="h5 text-primary mb-0">{{ stats.monthly_schedules }}</p>
                                                <small class="text-muted">天</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="p-3">
                                                <i class="bi bi-clock display-6 text-success"></i>
                                                <h6 class="mt-2">本月工时</h6>
                                                <p class="h5 text-success mb-0">{{ "%.1f"|format(stats.monthly_hours) }}</p>
                                                <small class="text-muted">小时</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="p-3">
                                                <i class="bi bi-trophy display-6 text-warning"></i>
                                                <h6 class="mt-2">本月工分</h6>
                                                <p class="h5 text-warning mb-0">{{ "%.1f"|format(stats.monthly_score) }}</p>
                                                <small class="text-muted">分</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="p-3">
                                                <i class="bi bi-graph-up display-6 text-info"></i>
                                                <h6 class="mt-2">年度工分</h6>
                                                <p class="h5 text-info mb-0">{{ "%.1f"|format(stats.yearly_score) }}</p>
                                                <small class="text-muted">分</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                               </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const leaveForm = document.getElementById('leaveForm');
    const usedLeaveInput = document.getElementById('used_leave_days');

    // 实时验证输入
    if (usedLeaveInput) {
        usedLeaveInput.addEventListener('input', function() {
            const value = parseInt(this.value);
            const max = parseInt(this.max);
            const min = parseInt(this.min);

            // 清除之前的验证状态
            this.classList.remove('is-valid', 'is-invalid');

            if (isNaN(value)) {
                this.classList.add('is-invalid');
            } else if (value >= min && value <= max) {
                this.classList.add('is-valid');
            } else {
                this.classList.add('is-invalid');
            }
        });

        // 表单提交前的最终验证
        if (leaveForm) {
            leaveForm.addEventListener('submit', function(e) {
                const value = parseInt(usedLeaveInput.value);
                const max = parseInt(usedLeaveInput.max);
                const min = parseInt(usedLeaveInput.min);

                if (isNaN(value) || value < min || value > max) {
                    e.preventDefault();
                    alert(`请输入有效的年假天数（${min}-${max}天）`);
                    usedLeaveInput.focus();
                    return;
                }

                // 添加确认提示
                const currentValue = parseInt(usedLeaveInput.getAttribute('value'));
                if (value !== currentValue) {
                    if (!confirm(`确定要将已休年假从${currentValue}天更新为${value}天吗？`)) {
                        e.preventDefault();
                        return;
                    }
                }
            });
        }
    }
});
</script>
{% endblock %}