{% extends "layouts/base.html" %}

{% block title %}编辑医生 - {{ doctor.name }} - 医院排班管理系统{% endblock %}

{% block content %}
<div class="container">
    <!-- 页面头部 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
            <i class="bi bi-pencil-square text-warning"></i>
            编辑医生信息
        </h1>
        <div>
            <a href="{{ url_for('main.view_doctor', doctor_id=doctor.id) }}" class="btn btn-info text-white">
                <i class="bi bi-eye"></i> 查看详情
            </a>
            <a href="{{ url_for('main.doctors') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> 返回列表
            </a>
        </div>
    </div>

     <div class="edit-centered-layout">
    <div class="card shadow-sm">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0">
                <i class="bi bi-person-check"></i> 编辑医生信息
            </h5>
        </div>
        <div class="card-body">
            <!-- 当前医生信息显示 -->
            <div class="alert alert-info mb-4">
                <i class="bi bi-info-circle"></i>
                当前编辑医生：<strong>{{ doctor.name }}</strong>
                {% if can_edit_avatar_only %}
                <br><small class="text-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    您是关联用户，只能修改该医生的头像信息
                </small>
                {% endif %}
            </div>

            <form method="POST" enctype="multipart/form-data" id="doctorForm">
                        <!-- 基本信息部分 -->
                        <div class="mb-4">

                            <!-- 头像上传 -->
                            <div class="text-center mb-4">
                                <div class="avatar-upload">
                                    <label for="avatarInput" class="avatar-label">
                                        <img id="avatarPreview"
                                             src="{{ doctor.get_avatar_url() }}"
                                             alt="头像预览"
                                             class="rounded-circle avatar-preview">
                                        <div class="avatar-overlay">
                                            <i class="bi bi-camera"></i>
                                            <small>点击更换头像</small>
                                        </div>
                                    </label>
                                    <input type="file" name="avatar" id="avatarInput" class="d-none" accept="image/*">
                                    <input type="hidden" name="croppedAvatar" id="croppedAvatar" value="">
                                </div>
                                <small class="text-muted">
                                    当前头像：{{ '自定义头像' if doctor.avatar else '性别默认头像' }}<br>
                                    支持更换 JPG、PNG 格式，最大 5MB<br>
                                    上传后可裁剪调整头像区域<br>
                                    清空头像后，切换性别将自动更换默认头像
                                </small>
                            </div>

                            <!-- 图片裁剪模态框 -->
                            <div class="modal fade" id="avatarCropModal" tabindex="-1" aria-labelledby="avatarCropModalLabel" aria-hidden="true">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="avatarCropModalLabel">
                                                <i class="bi bi-crop"></i> 裁剪头像
                                            </h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="row">
                                                <div class="col-md-8">
                                                    <div class="cropper-container" style="max-height: 400px;">
                                                        <img id="cropperImage" style="max-width: 100%;">
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="d-grid gap-2">
                                                        <button type="button" class="btn btn-outline-secondary btn-sm" id="rotateLeft">
                                                            <i class="bi bi-arrow-counterclockwise"></i> 左旋转
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary btn-sm" id="rotateRight">
                                                            <i class="bi bi-arrow-clockwise"></i> 右旋转
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary btn-sm" id="flipHorizontal">
                                                            <i class="bi bi-symmetry-horizontal"></i> 水平翻转
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary btn-sm" id="flipVertical">
                                                            <i class="bi bi-symmetry-vertical"></i> 垂直翻转
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary btn-sm" id="resetCrop">
                                                            <i class="bi bi-arrow-clockwise"></i> 重置
                                                        </button>
                                                    </div>
                                                    <hr>
                                                    <small class="text-muted">
                                                        <strong>操作提示：</strong><br>
                                                        • 拖动图片调整位置<br>
                                                        • 拖动角落调整大小<br>
                                                        • 滚轮缩放图片<br>
                                                        • 双击重置裁剪框
                                                    </small>
                                                </div>
                                            </div>
                                            <!-- 预览区域 -->
                                            <div class="mt-3">
                                                <h6>预览效果：</h6>
                                                <div class="d-flex gap-3 align-items-center">
                                                    <div class="text-center">
                                                        <div class="cropper-preview" style="width: 100px; height: 100px; overflow: hidden; border-radius: 50%; border: 2px solid #dee2e6;"></div>
                                                        <small class="d-block mt-1">100x100</small>
                                                    </div>
                                                    <div class="text-center">
                                                        <div class="cropper-preview" style="width: 50px; height: 50px; overflow: hidden; border-radius: 50%; border: 2px solid #dee2e6;"></div>
                                                        <small class="d-block mt-1">50x50</small>
                                                    </div>
                                                    <div class="text-center">
                                                        <div class="cropper-preview" style="width: 30px; height: 30px; overflow: hidden; border-radius: 50%; border: 2px solid #dee2e6;"></div>
                                                        <small class="d-block mt-1">30x30</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                            <button type="button" class="btn btn-primary" id="confirmCrop">
                                                <i class="bi bi-check"></i> 确认裁剪
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 姓名 -->
                            <div class="mb-3">
                                <label for="name" class="field-label">
                                    <i class="bi bi-person"></i> 医生姓名
                                    {% if not can_edit_avatar_only %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                <input type="text" class="form-control form-control-sm" id="name" name="name"
                                       {% if not can_edit_avatar_only %}required{% endif %}
                                       value="{{ doctor.name }}" placeholder="请输入医生姓名" style="max-width: 150px;"
                                       {% if can_edit_avatar_only %}readonly disabled{% endif %}>
                                {% if can_edit_avatar_only %}
                                <small class="form-text text-muted">关联用户不能修改医生姓名</small>
                                {% endif %}
                            </div>

                            <!-- 职称 -->
                            <div class="mb-3">
                                <label for="title" class="field-label">
                                    <i class="bi bi-award"></i> 职称
                                    {% if not can_edit_avatar_only %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                <select class="form-select form-select-sm" id="title" name="title"
                                        {% if not can_edit_avatar_only %}required{% endif %}
                                        {% if can_edit_avatar_only %}disabled{% endif %} style="max-width: 150px;">
                                    <option value="主任医师" {% if doctor.title == '主任医师' %}selected{% endif %}>主任医师</option>
                                    <option value="副主任医师" {% if doctor.title == '副主任医师' %}selected{% endif %}>副主任医师</option>
                                    <option value="医师" {% if doctor.title == '医师' %}selected{% endif %}>医师</option>
                                    <option value="打字员" {% if doctor.title == '打字员' %}selected{% endif %}>打字员</option>
                                </select>
                                {% if can_edit_avatar_only %}
                                <small class="form-text text-muted">关联用户不能修改医生职称</small>
                                {% endif %}
                            </div>

                            <!-- 在职状态 -->
                            <div class="mb-3">
                                <label for="status" class="field-label">
                                    <i class="bi bi-person-check"></i> 在职状态
                                    {% if not can_edit_avatar_only %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                <select class="form-select form-select-sm" id="status" name="status"
                                        {% if not can_edit_avatar_only %}required{% endif %}
                                        {% if can_edit_avatar_only %}disabled{% endif %} style="max-width: 150px;">
                                    <option value="在职" {% if doctor.status == '在职' %}selected{% endif %}>在职</option>
                                    <option value="离职" {% if doctor.status == '离职' %}selected{% endif %}>离职</option>
                                </select>
                                {% if can_edit_avatar_only %}
                                <small class="form-text text-muted">关联用户不能修改医生状态</small>
                                {% endif %}
                            </div>

                            <!-- 性别 -->
                            <div class="mb-3">
                                <label class="field-label">
                                    <i class="bi bi-gender-ambiguous"></i> 性别
                                    {% if not can_edit_avatar_only %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                <div class="row">
                                    <div class="col-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="gender" id="gender_male"
                                                   value="男" {% if not can_edit_avatar_only %}required{% endif %}
                                                   {{ 'checked' if doctor.gender == '男' else '' }}
                                                   {% if can_edit_avatar_only %}disabled{% endif %}>
                                            <label class="form-check-label" for="gender_male">
                                                <i class="bi bi-gender-male text-primary"></i> 男
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="gender" id="gender_female"
                                                   value="女" {% if not can_edit_avatar_only %}required{% endif %}
                                                   {{ 'checked' if doctor.gender == '女' else '' }}
                                                   {% if can_edit_avatar_only %}disabled{% endif %}>
                                            <label class="form-check-label" for="gender_female">
                                                <i class="bi bi-gender-female text-danger"></i> 女
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                {% if can_edit_avatar_only %}
                                <small class="form-text text-muted">关联用户不能修改医生性别</small>
                                {% endif %}
                            </div>

                            <!-- 擅长方向 -->
                            <div class="mb-3">
                                <label class="field-label">
                                    <i class="bi bi-star"></i> 擅长方向
                                    {% if not can_edit_avatar_only %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                <div class="row">
                                    {% for spec in specialties %}
                                        <div class="col-6 col-md-3 mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="specialties"
                                                       value="{{ spec.name }}" id="specialty_{{ loop.index }}"
                                                       {% if spec.name in doctor.get_specialties_list() %}checked{% endif %}
                                                       {% if can_edit_avatar_only %}disabled{% endif %}>
                                                <label class="form-check-label" for="specialty_{{ loop.index }}">
                                                    <span class="badge bg-secondary">{{ spec.name }}</span>
                                                </label>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                                <small class="form-text text-muted">
                                    {% if can_edit_avatar_only %}
                                    关联用户不能修改擅长方向
                                    {% else %}
                                    可以选择多个擅长方向，不区分优先级
                                    {% endif %}
                                </small>
                            </div>

                        {% if not can_edit_avatar_only %}
                        <!-- 年假信息部分 -->
                        <div class="mb-3">
                            <label for="annual_leave_days" class="field-label">
                                <i class="bi bi-calendar-plus"></i> 每年年假天数
                            </label>
                            <input type="number" class="form-control form-control-sm" id="annual_leave_days" name="annual_leave_days"
                                       value="{{ doctor.annual_leave_days }}" min="0" max="365"
                                       style="max-width: 150px;" placeholder="天数">
                        </div>

                        <!-- 已休年假天数部分 -->
                        <div class="mb-3" id="usedLeaveSection" style="display: none;">
                            <label for="used_leave_days" class="field-label">
                                <i class="bi bi-calendar-minus"></i> 已休年假天数
                                <small class="text-muted">(不超过每年年假天数)</small>
                            </label>
                            <input type="number" class="form-control form-control-sm" id="used_leave_days" name="used_leave_days"
                                       value="{{ doctor.used_leave_days if doctor.used_leave_days is not none else 0 }}" min="0" max="{{ doctor.annual_leave_days }}"
                                       style="max-width: 150px;" placeholder="已休天数">
                            <div class="form-text">
                                <span id="remainingDays">剩余：{{ doctor.annual_leave_days - doctor.used_leave_days }}天</span>
                            </div>
                        </div>
                        {% else %}
                        <!-- 年假信息显示（只读） -->
                        <div class="mb-4">
                            <h6 class="text-primary mb-3">
                                <i class="bi bi-calendar-check"></i> 年假信息
                            </h6>
                            <div class="card bg-light">
                                <div class="card-body">
                                    <p class="mb-2">
                                        <strong>每年年假天数：</strong>{{ doctor.annual_leave_days }}天
                                    </p>
                                    <p class="mb-0">
                                        <strong>已使用：</strong><span class="badge bg-warning">{{ doctor.used_leave_days }}天</span>
                                        <strong class="ms-3">剩余：</strong><span class="badge bg-success">{{ doctor.annual_leave_days - doctor.used_leave_days }}天</span>
                                    </p>
                                    <small class="form-text text-muted mt-2">关联用户不能修改年假信息</small>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                                                <!-- 序号管理部分 - 仅超级管理员可见 -->
                        {% if current_user.is_super_admin %}
                        <div class="mb-3">
                            <label for="sequence" class="field-label">
                                <i class="bi bi-hash"></i> 显示序号
                            </label>
                            <input type="number" class="form-control form-control-sm" id="sequence" name="sequence"
                                       value="{{ doctor.sequence or 999 }}" min="1" max="9999"
                                       style="max-width: 150px;" placeholder="序号">
                        </div>
                        {% endif %}

                        <!-- 提交按钮 -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-warning btn-lg">
                                <i class="bi bi-check-circle"></i> 保存更改
                            </button>
                            <a href="{{ url_for('main.view_doctor', doctor_id=doctor.id) }}" class="btn btn-outline-info">
                                <i class="bi bi-x-circle"></i> 取消
                            </a>
                        </div>
                    </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Cropper.js CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" />

<!-- Cropper.js JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 年假天数动态显示功能
    const annualLeaveInput = document.getElementById('annual_leave_days');
    const usedLeaveSection = document.getElementById('usedLeaveSection');
    const usedLeaveInput = document.getElementById('used_leave_days');
    const remainingDaysSpan = document.getElementById('remainingDays');

    // 初始显示/隐藏已休年假天数字段
    if (annualLeaveInput && annualLeaveInput.value && parseInt(annualLeaveInput.value) > 0) {
        // 只有当年假天数大于0时才显示已休天数字段
        usedLeaveSection.style.display = 'block';
        updateRemainingDays();
    } else {
        // 年假天数为0或空时，隐藏已休天数字段
        usedLeaveSection.style.display = 'none';
        // 确保已休天数字段的值为0
        if (usedLeaveInput) {
            usedLeaveInput.value = 0;
        }
    }

    // 声明用户输入的已休天数变量（真正要保存的数据）
    let originalUsedDays = 0;
    // 临时显示的已休天数（用于表单验证）
    let temporaryUsedDays = 0;

    // 只有当年假天数大于0时才保留原始的已休天数
    if (annualLeaveInput && annualLeaveInput.value && parseInt(annualLeaveInput.value) > 0) {
        originalUsedDays = parseInt(usedLeaveInput.value) || 0;
        temporaryUsedDays = originalUsedDays;
    }

    // 监听每年年假天数输入
    if (annualLeaveInput) {

        annualLeaveInput.addEventListener('input', function() {
            const newAnnualDays = parseInt(this.value) || 0;

            if (newAnnualDays > 0) {
                usedLeaveSection.style.display = 'block';

                if (usedLeaveInput) {
                    usedLeaveInput.max = newAnnualDays;

                    // 恢复原始数据，并根据新的年假天数调整
                    if (originalUsedDays <= newAnnualDays) {
                        // 如果原始已休天数小于等于新的年假天数，恢复原始值
                        temporaryUsedDays = originalUsedDays;
                        usedLeaveInput.value = originalUsedDays;
                    } else {
                        // 如果原始已休天数大于新的年假天数，调整为最大值
                        temporaryUsedDays = newAnnualDays;
                        usedLeaveInput.value = newAnnualDays;
                    }
                }
                updateRemainingDays();
            } else {
                // 年假天数为0时，隐藏字段但保留原始数据，临时显示为0
                usedLeaveSection.style.display = 'none';
                if (usedLeaveInput) {
                    usedLeaveInput.value = 0; // 临时显示为0
                }
                temporaryUsedDays = 0; // 临时值为0，但originalUsedDays保持不变
            }
        });

        // 当年假天数失去焦点时，如果为空则隐藏已休天数字段
        annualLeaveInput.addEventListener('blur', function() {
            if (!this.value || this.value <= 0) {
                usedLeaveSection.style.display = 'none';
                if (usedLeaveInput) {
                    usedLeaveInput.value = 0; // 临时显示为0
                }
                temporaryUsedDays = 0; // 临时值为0
            }
        });
    }

    // 监听已休年假天数输入
    if (usedLeaveInput) {
        usedLeaveInput.addEventListener('input', function() {
            validateUsedLeave();
            updateRemainingDays();
            // 用户手动修改已休天数时，更新原始数据
            const annualDays = parseInt(annualLeaveInput.value) || 0;
            const newUsedDays = parseInt(this.value) || 0;

            if (annualDays > 0 && newUsedDays <= annualDays) {
                // 只有在年假天数大于0且输入值合理时，才更新原始数据
                originalUsedDays = newUsedDays;
                temporaryUsedDays = newUsedDays;
            }
        });
    }

    // 更新剩余天数显示
    function updateRemainingDays() {
        if (annualLeaveInput && usedLeaveInput && remainingDaysSpan) {
            const annualDays = parseInt(annualLeaveInput.value) || 0;
            const usedDays = parseInt(usedLeaveInput.value) || 0;
            const remaining = annualDays - usedDays;
            remainingDaysSpan.textContent = `剩余：${remaining}天`;

            // 根据剩余天数改变颜色
            if (remaining < 0) {
                remainingDaysSpan.style.color = '#dc3545'; // 红色
            } else if (remaining <= 3) {
                remainingDaysSpan.style.color = '#ffc107'; // 黄色
            } else {
                remainingDaysSpan.style.color = '#28a745'; // 绿色
            }
        }
    }

    // 验证已休年假天数
    function validateUsedLeave() {
        if (usedLeaveInput && annualLeaveInput) {
            const annualDays = parseInt(annualLeaveInput.value) || 0;
            const usedDays = parseInt(usedLeaveInput.value) || 0;

            // 清除之前的验证状态
            usedLeaveInput.classList.remove('is-valid', 'is-invalid');

            if (usedDays < 0) {
                usedLeaveInput.classList.add('is-invalid');
            } else if (usedDays > annualDays) {
                usedLeaveInput.classList.add('is-invalid');
            } else {
                usedLeaveInput.classList.add('is-valid');
            }
        }
    }

    // 头像预览功能
    const avatarInput = document.getElementById('avatarInput');
    const avatarPreview = document.getElementById('avatarPreview');
    let originalAvatarSrc = avatarPreview.src;
    let hasCustomAvatar = {{ 'true' if doctor.avatar else 'false' }}; // 判断是否有自定义头像

    // 性别切换功能
    function updateDefaultAvatar(gender) {
        if (!hasCustomAvatar) {
            // 只有在没有自定义头像时才切换默认头像
            if (gender === '女') {
                avatarPreview.src = "{{ url_for('static', filename='images/default_female_avatar.jpg') }}";
            } else {
                avatarPreview.src = "{{ url_for('static', filename='images/default_male_avatar.jpg') }}";
            }
        }
    }

    // 监听性别选择变化
    document.querySelectorAll('input[name="gender"]').forEach(radio => {
        radio.addEventListener('change', function() {
            updateDefaultAvatar(this.value);
        });
    });

    let cropper = null;
    let currentFile = null;

    // 头像上传处理
    avatarInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            // 检查文件大小
            if (file.size > 5 * 1024 * 1024) {
                alert('文件大小不能超过 5MB');
                e.target.value = '';
                return;
            }

            // 检查文件类型
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/bmp'];
            if (!allowedTypes.includes(file.type)) {
                alert('请选择有效的图片文件 (JPG、PNG、GIF、BMP)');
                e.target.value = '';
                return;
            }

            currentFile = file;

            // 预览图片
            const reader = new FileReader();
            reader.onload = function(e) {
                // 设置裁剪器图片
                const cropperModal = new bootstrap.Modal(document.getElementById('avatarCropModal'));
                const cropperImage = document.getElementById('cropperImage');
                cropperImage.src = e.target.result;

                // 显示模态框
                cropperModal.show();

                // 初始化裁剪器
                setTimeout(() => {
                    if (cropper) {
                        cropper.destroy();
                    }

                    cropper = new Cropper(cropperImage, {
                        aspectRatio: 1, // 1:1 比例，适合头像
                        viewMode: 1,
                        dragMode: 'move',
                        autoCropArea: 0.8,
                        restore: false,
                        guides: true,
                        center: true,
                        highlight: true,
                        cropBoxMovable: true,
                        cropBoxResizable: true,
                        toggleDragModeOnDblclick: true,
                        preview: document.querySelectorAll('.cropper-preview'),
                        ready: function() {
                            // 初始化预览
                            updatePreviews();
                        },
                        crop: function() {
                            // 实时更新预览
                            updatePreviews();
                        }
                    });
                }, 200);
            };
            reader.readAsDataURL(file);
        } else {
            hasCustomAvatar = false; // 清空文件，重置标记
            // 根据当前性别选择恢复默认头像
            const currentGender = document.querySelector('input[name="gender"]:checked')?.value || '男';
            updateDefaultAvatar(currentGender);
        }
    });

    // 更新预览
    function updatePreviews() {
        if (!cropper) return;

        const previews = document.querySelectorAll('.cropper-preview');
        previews.forEach(function(preview) {
            const previewWidth = preview.offsetWidth;
            const previewHeight = preview.offsetHeight;
            const canvasData = cropper.getCroppedCanvas({
                width: previewWidth,
                height: previewHeight,
                minWidth: previewWidth,
                minHeight: previewHeight,
                maxWidth: previewWidth,
                maxHeight: previewHeight,
                fill: '#fff',
                imageSmoothingEnabled: true,
                imageSmoothingQuality: 'high'
            });

            preview.style.backgroundImage = 'url(' + canvasData.toDataURL() + ')';
            preview.style.backgroundSize = 'cover';
            preview.style.backgroundPosition = 'center';
        });
    }

    // 旋转功能
    document.getElementById('rotateLeft').addEventListener('click', function() {
        if (cropper) {
            cropper.rotate(-90);
        }
    });

    document.getElementById('rotateRight').addEventListener('click', function() {
        if (cropper) {
            cropper.rotate(90);
        }
    });

    // 翻转功能
    document.getElementById('flipHorizontal').addEventListener('click', function() {
        if (cropper) {
            cropper.scaleX(-cropper.getData().scaleX || -1);
        }
    });

    document.getElementById('flipVertical').addEventListener('click', function() {
        if (cropper) {
            cropper.scaleY(-cropper.getData().scaleY || -1);
        }
    });

    // 重置功能
    document.getElementById('resetCrop').addEventListener('click', function() {
        if (cropper) {
            cropper.reset();
        }
    });

    // 确认裁剪
    document.getElementById('confirmCrop').addEventListener('click', function() {
        if (cropper) {
            // 获取裁剪后的画布
            const canvas = cropper.getCroppedCanvas({
                width: 300, // 输出宽度
                height: 300, // 输出高度
                minWidth: 300,
                minHeight: 300,
                maxWidth: 300,
                maxHeight: 300,
                fill: '#fff',
                imageSmoothingEnabled: true,
                imageSmoothingQuality: 'high'
            });

            // 转换为blob并设置预览
            canvas.toBlob(function(blob) {
                const url = URL.createObjectURL(blob);
                avatarPreview.src = url;

                // 将裁剪后的图片转换为base64并保存到隐藏字段
                canvas.toDataURL('image/jpeg', 0.9);
                const base64Data = canvas.toDataURL('image/jpeg', 0.9);
                document.getElementById('croppedAvatar').value = base64Data;

                hasCustomAvatar = true;

                // 关闭模态框
                bootstrap.Modal.getInstance(document.getElementById('avatarCropModal')).hide();

                // 销毁裁剪器
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }

                // 清空文件输入
                avatarInput.value = '';
            }, 'image/jpeg', 0.9);
        }
    });

    // 模态框关闭时清理
    document.getElementById('avatarCropModal').addEventListener('hidden.bs.modal', function() {
        if (cropper) {
            cropper.destroy();
            cropper = null;
        }
        currentFile = null;
    });

    // 表单验证
    const form = document.getElementById('doctorForm');
    form.addEventListener('submit', function(e) {
        const name = document.getElementById('name').value.trim();
        const gender = document.querySelector('input[name="gender"]:checked');
        const specialtyCheckboxes = document.querySelectorAll('input[name="specialties"]:checked');
        const annualLeaveDays = document.getElementById('annual_leave_days').value;
        const usedLeaveDays = document.getElementById('used_leave_days').value;

        if (!name) {
            alert('请输入医生姓名');
            e.preventDefault();
            return;
        }

        if (!gender) {
            alert('请选择性别');
            e.preventDefault();
            return;
        }

        if (specialtyCheckboxes.length === 0) {
            alert('请至少选择一个擅长方向');
            e.preventDefault();
            return;
        }

        if (annualLeaveDays < 0 || annualLeaveDays > 365) {
            alert('年假天数必须在 0-365 之间');
            e.preventDefault();
            return;
        }

        // 验证已休年假天数不能超过每年年假天数（使用当前显示的值进行验证）
        if (usedLeaveDays && parseInt(usedLeaveDays) > parseInt(annualLeaveDays)) {
            alert('已休年假天数不能超过每年年假天数');
            e.preventDefault();
            document.getElementById('used_leave_days').focus();
            return;
        }

        // 如果年假天数小于已使用天数，给出警告（使用当前显示的已休天数）
        if (parseInt(annualLeaveDays) < parseInt(usedLeaveDays || 0)) {
            if (!confirm(`警告：年假天数(${annualLeaveDays}天)小于已使用天数(${usedLeaveDays}天)，确定要继续吗？`)) {
                e.preventDefault();
                return;
            }
        }
    });
});
</script>
{% endblock %}