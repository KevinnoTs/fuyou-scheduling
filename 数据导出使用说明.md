# 数据导出使用说明

## 概述

`export_data.py` 是一个强大的数据库导出工具，可以同时导出医生表和用户表的完整数据，生成可重用的初始化脚本。

## 功能特性

### 🎯 支持的数据表
- **医生表 (doctors)**: 包括所有医生的基本信息、擅长方向、年假等
- **用户表 (users)**: 包括所有用户账户信息、权限设置、医生关联等

### 🔧 智能功能
- **状态识别**: 自动识别在职/离职医生
- **权限分类**: 分类统计超级管理员、管理员、普通用户
- **关联验证**: 只导出有效的医生-用户关联关系
- **数据完整性**: 保留密码哈希，确保用户账户可正常使用

## 使用方法

### 快速开始

1. **运行导出脚本**:
   ```bash
   python export_data.py
   ```

2. **查看导出结果**:
   - 脚本会显示详细的导出统计
   - 生成 `database_init_data.py` 文件

3. **使用生成的初始化文件**:
   ```bash
   # 方法1: 移动到app目录并在应用初始化时调用
   mv database_init_data.py app/

   # 方法2: 直接运行初始化
   python app/database_init_data.py
   ```

## 导出内容详解

### 医生数据导出

导出的医生信息包括：
- **基本信息**: 姓名、性别、职称、状态
- **专业信息**: 擅长方向（JSON格式）
- **休假信息**: 年假天数、已用天数
- **其他信息**: 头像、排序序号

**导出示例**:
```json
{
    "name": "张三",
    "gender": "女",
    "title": "主任医师",
    "status": "在职",
    "specialties": "[\"妇科\", \"产科\"]",
    "annual_leave_days": 15,
    "used_leave_days": 0,
    "avatar": null,
    "sequence": 1
}
```

### 用户数据导出

导出的用户信息包括：
- **账户信息**: 用户名、密码哈希、全名
- **权限信息**: 管理员状态、超级管理员状态
- **状态信息**: 账户是否激活
- **关联信息**: 关联的医生ID和医生姓名

**导出示例**:
```json
{
    "username": "admin",
    "password_hash": "pbkdf2:sha256:...",
    "full_name": "系统管理员",
    "is_admin": True,
    "is_super_admin": True,
    "is_active": True,
    "associated_doctor_id": null,
    "associated_doctor_name": null,
    "associated_doctor_status": null
}
```

## 导出统计信息

运行脚本时会显示详细的统计信息：

### 医生统计
```
👨‍⚕️ 导出医生数据...
   找到 8 名医生（包括在职和离职）
   - 在职医生: 6 名
   - 离职医生: 2 名
```

### 用户统计
```
👤 导出用户数据...
   找到 4 个用户账户
   - 超级管理员: 1 个
   - 普通管理员: 2 个
   - 普通用户: 1 个
```

### 总体统计
```
📋 导出统计:
   医生数据:
     - 总计: 8 名
     - 在职: 6 名
     - 离职: 2 名
   用户数据:
     - 总计: 4 个
     - 管理员: 3 个
     - 关联医生: 2 个
```

## 生成的初始化文件

### 文件结构
生成的 `database_init_data.py` 包含：
- 完整的初始化代码
- 医生数据初始化函数 (`init_doctors`)
- 用户数据初始化函数 (`init_users`)
- 主初始化函数 (`init_all_data`)

### 使用方法

#### 方法1: 应用初始化时调用
```python
from app.database_init_data import init_all_data

# 在应用启动时调用
init_all_data()
```

#### 方法2: 独立运行
```bash
python app/database_init_data.py
```

### 安全特性

1. **密码安全**: 保留密码哈希，不存储明文密码
2. **关联验证**: 只关联在职医生的账户
3. **重复检查**: 避免创建重复数据
4. **错误处理**: 完善的错误处理和回滚机制

## 高级功能

### 数据筛选

如果只需要导出特定条件的数据，可以修改脚本中的查询条件：

**只导出在职医生**:
```python
doctors = Doctor.query.filter_by(status='在职').order_by(Doctor.sequence).all()
```

**只导出管理员用户**:
```python
users = User.query.filter((User.is_admin == True) | (User.is_super_admin == True)).all()
```

### 自定义字段

可以根据需要添加或删除导出字段：

**添加医生字段**:
```python
doctor_data['custom_field'] = doctor.custom_value
```

**添加用户字段**:
```python
user_data['last_login'] = user.last_login.isoformat() if user.last_login else None
```

## 故障排除

### 常见问题

1. **数据库连接错误**
   - 确保应用配置正确
   - 检查数据库文件权限

2. **编码问题**
   - 脚本使用UTF-8编码处理中文
   - 确保文件保存时编码正确

3. **字段不存在错误**
   - 检查模型定义是否与数据库结构一致
   - 运行数据库迁移更新

### 调试技巧

1. **查看详细错误信息**:
   ```bash
   python export_data.py
   # 查看完整的错误堆栈
   ```

2. **检查生成的文件**:
   ```bash
   cat database_init_data.py | head -50
   # 查看生成的初始化代码
   ```

3. **测试初始化**:
   ```python
   # 在Python交互环境中测试
   from app.database_init_data import init_all_data
   init_all_data()
   ```

## 最佳实践

### 定期备份
- 建议定期运行导出脚本备份数据
- 保存不同时间点的初始化文件

### 版本控制
- 将初始化文件纳入版本控制
- 使用有意义的提交信息

### 数据迁移
- 在系统升级前导出当前数据
- 使用导出的文件进行数据验证

## 文件说明

- **export_data.py**: 主要的导出脚本
- **export_doctors.py**: 旧的医生导出脚本（已废弃）
- **database_init_data.py**: 生成的初始化文件（运行后产生）

---

通过这个强大的数据导出工具，您可以轻松备份和迁移完整的医生和用户数据，确保系统的可维护性和数据安全性！