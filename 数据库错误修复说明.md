# 数据库错误修复说明

## 问题描述

在查看医生详情页面时出现以下错误：
```
AttributeError: type object 'Schedule' has no attribute 'shift_type_id'
```

## 问题原因

1. **模型结构不匹配**: `Doctor` 模型中的工时和工分计算方法试图通过 `Schedule.shift_type_id` 关联 `ShiftType` 表，但 `Schedule` 模型实际只有 `shift` 字段（班次名称），没有 `shift_type_id` 外键字段。

2. **状态值错误**: 原代码使用 `Schedule.status == '正常'`，但实际的状态值是 `'assigned'` 和 `'unassigned'`。

3. **班次类型缺失**: 系统中缺少"夜班"班次类型，但上传功能中使用到了这个班次。

## 修复内容

### 1. 修复工时计算方法 (`models.py:223-234`)

**修复前:**
```python
total_hours = db.session.query(sa.func.sum(ShiftType.duration_hours)).join(
    Schedule, ShiftType.id == Schedule.shift_type_id
).filter(
    Schedule.doctor_id == self.id,
    Schedule.status == '正常'
).scalar()
```

**修复后:**
```python
total_hours = db.session.query(sa.func.sum(ShiftType.duration_hours)).join(
    Schedule, ShiftType.name == Schedule.shift
).filter(
    Schedule.doctor_id == self.id,
    Schedule.status == 'assigned'  # 使用正确的状态值
).scalar() or 0
```

### 2. 修复工分计算方法 (`models.py:253-264`)

**修复前:**
```python
total_score = db.session.query(sa.func.sum(ShiftType.work_score)).join(
    Schedule, ShiftType.id == Schedule.shift_type_id
).filter(
    Schedule.doctor_id == self.id,
    Schedule.status == '正常'
).scalar()
```

**修复后:**
```python
total_score = db.session.query(sa.func.sum(ShiftType.work_score)).join(
    Schedule, ShiftType.name == Schedule.shift
).filter(
    Schedule.doctor_id == self.id,
    Schedule.status == 'assigned'  # 使用正确的状态值
).scalar() or 0
```

### 3. 修复年度工分计算方法 (`models.py:280-290`)

同样修复了 `get_yearly_work_score` 方法中的相同问题。

### 4. 添加"夜班"班次类型 (`init_data.py:69-76`)

```python
{
    'name': '夜班',
    'start_time': time(16, 0),
    'end_time': time(23, 59),
    'duration_hours': 8.0,
    'work_score': 1.2,
    'description': '下午4点-午夜 (8小时)'
},
```

## 修复后的数据库结构

### Schedule 模型字段
- `id`: 主键
- `doctor_id`: 医生ID（外键）
- `date`: 排班日期
- `weekday`: 星期几
- `shift`: 班次名称（如：白班、夜班、中班等）
- `time_range`: 时间范围
- `department`: 科室
- `status`: 状态（assigned/unassigned）
- `notes`: 备注
- `created_at`: 创建时间
- `updated_at`: 更新时间

### ShiftType 模型字段
- `id`: 主键
- `name`: 班次名称
- `start_time`: 开始时间
- `end_time`: 结束时间
- `duration_hours`: 持续小时数
- `work_score`: 工作量分值
- `description`: 描述
- `created_at`: 创建时间

### 关联方式
- `Schedule.shift` ↔ `ShiftType.name` （通过名称关联）
- 不是通过外键ID关联，而是通过班次名称匹配

## 测试验证

创建了测试脚本 `test_fix.py` 来验证修复：

1. **检查班次类型**: 验证所有班次类型是否正确初始化
2. **测试工时计算**: 验证医生工时计算是否正常工作
3. **验证数据关联**: 检查排班记录中的班次是否在班次类型表中存在

## 使用方法

### 1. 运行测试脚本
```bash
cd fuyou_scheduling
python test_fix.py
```

### 2. 重新初始化数据库（如果需要）
```python
# 在Python环境中
from app import create_app
from app.init_data import init_shift_types, init_specialties

app = create_app()
with app.app_context():
    init_shift_types()      # 初始化班次类型
    init_specialties()     # 初始化擅长方向
```

### 3. 验证修复
- 访问医生详情页面，确认不再出现 `shift_type_id` 错误
- 检查工时和工分显示是否正常
- 验证上传排班表功能是否正常工作

## 注意事项

1. **数据一致性**: 确保 `Schedule.shift` 中的班次名称与 `ShiftType.name` 完全匹配
2. **状态值**: 使用 `'assigned'` 和 `'unassigned'` 作为状态值，不再使用 `'正常'`
3. **班次初始化**: 确保在系统中使用所有班次之前，先初始化班次类型数据
4. **备份**: 在进行数据库结构修改前，建议先备份现有数据

## 相关文件

- `app/models.py`: 修复工时和工分计算方法
- `app/init_data.py`: 添加"夜班"班次类型
- `test_fix.py`: 测试脚本
- `requirements.txt`: 更新依赖包列表