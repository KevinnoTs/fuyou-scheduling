# 医生数据管理说明

## 概述

本系统提供了完整的医生数据管理功能，包括数据初始化、导出、重置和恢复。当数据库清空后，可以快速恢复医生数据。

## 文件结构

```
hospital_scheduling/
├── app/
│   ├── doctors_init_data.py          # 医生数据初始化脚本
│   └── init_data.py                  # 基础数据初始化脚本（已更新）
├── export_doctors.py                 # 医生数据导出脚本
├── reset_database.py                 # 数据库重置脚本
├── test_doctor_init.py              # 测试脚本
└── 医生数据管理说明.md               # 本说明文档
```

## 主要功能

### 1. 医生数据初始化 (`app/doctors_init_data.py`)

**功能**: 创建默认医生数据和关联用户账户

**默认医生数据**:
- 张三 (女, 主任医师) - 妇科、产科
- 李四 (男, 副主任医师) - 儿科
- 王五 (女, 主治医师) - 门诊、筛查
- 赵六 (男, 住院医师) - 急诊
- 孙七 (女, 主任医师) - 产科
- 周八 (男, 主治医师) - 妇科、筛查
- 吴九 (女, 副主任医师) - 儿科、门诊
- 郑十 (男, 住院医师) - 急诊、门诊

**默认用户账户**:
- `admin/admin123` - 超级管理员
- `zhangsan/zhangsan123` - 张三，管理员
- `lisi/lisi123` - 李四，管理员
- `wangwu/wangwu123` - 王五，普通用户

### 2. 医生数据导出 (`export_doctors.py`)

**功能**: 将当前数据库中的医生数据导出为初始化代码

**使用方法**:
```bash
python export_doctors.py
```

**输出**: `doctors_init_data.py` 文件，包含所有在职医生的数据

### 3. 数据库重置 (`reset_database.py`)

**功能**: 提供数据库管理功能，包括重置、备份等

**使用方法**:
```bash
python reset_database.py
```

**选项**:
1. 重置数据库（清空并重新初始化）
2. 重置数据库并备份现有数据
3. 仅备份数据库
4. 清空上传文件夹
5. 显示数据库信息
0. 退出

### 4. 测试功能 (`test_doctor_init.py`)

**功能**: 测试医生数据初始化功能是否正常工作

**使用方法**:
```bash
python test_doctor_init.py
```

## 使用场景

### 场景1: 新系统部署

```bash
# 1. 安装依赖
pip install -r requirements.txt

# 2. 初始化数据库（会自动调用医生数据初始化）
python run.py

# 3. 登录系统
# 用户名: admin
# 密码: admin123
```

### 场景2: 数据库清空后恢复

```bash
# 方法1: 使用重置脚本
python reset_database.py
# 选择选项 1 或 2

# 方法2: 手动初始化
python -c "
from app import create_app
from app.init_data import init_all_data
from app.doctors_init_data import init_doctors

app = create_app()
with app.app_context():
    init_all_data()  # 初始化基础数据
    init_doctors()   # 初始化医生数据
"
```

### 场景3: 导出当前医生数据

```bash
# 运行导出脚本
python export_doctors.py

# 导出的文件可以用于:
# 1. 备份医生数据
# 2. 在其他环境中恢复相同的医生数据
# 3. 版本控制
```

### 场景4: 自定义医生数据

1. **直接修改初始化文件**:
   编辑 `app/doctors_init_data.py` 中的 `doctors_data` 列表

2. **通过导出功能**:
   ```bash
   # 先导出现有数据
   python export_doctors.py
   # 将生成的 doctors_init_data.py 内容复制到 app/doctors_init_data.py
   ```

3. **通过系统界面添加**:
   - 登录系统
   - 进入医生管理页面
   - 手动添加医生
   - 导出数据保存为初始化文件

## 数据格式说明

### 医生数据格式

```python
{
    "name": "张三",                    # 医生姓名（必填）
    "gender": "女",                   # 性别：男/女（必填）
    "title": "主任医师",               # 职称（必填）
    "status": "在职",                  # 状态：在职/离职（必填）
    "specialties": "[\"妇科\"]",       # 擅长方向JSON数组（可选）
    "annual_leave_days": 15,          # 年假天数（可选，默认15）
    "used_leave_days": 0,             # 已用年假（可选，默认0）
    "avatar": null,                   # 头像文件名（可选）
    "sequence": 1,                    # 排序序号（可选）
    "notes": "资深妇科专家"           # 备注（可选）
}
```

### 用户数据格式

```python
{
    'username': 'zhangsan',           # 用户名（必填，唯一）
    'password': 'zhangsan123',        # 密码（必填）
    'full_name': '张三',               # 全名（可选）
    'is_admin': True,                 # 是否管理员（可选）
    'is_super_admin': False,          # 是否超级管理员（可选）
    'doctor_name': '张三'             # 关联的医生姓名（可选）
}
```

### 擅长方向格式

```python
["妇科", "产科"]  # JSON数组格式
```

支持的擅长方向:
- 妇科
- 产科
- 儿科
- 筛查

## 注意事项

### 安全提醒

1. **修改默认密码**: 在生产环境中，请务必修改默认用户密码
2. **权限管理**: 谨慎分配管理员权限
3. **数据备份**: 定期备份数据库文件

### 数据一致性

1. **医生姓名**: 用户关联的医生姓名必须与医生表中的姓名完全一致
2. **擅长方向**: 使用标准化的擅长方向名称
3. **状态值**: 使用规定的状态值（在职/离职）

### 文件管理

1. **头像文件**: 医生头像存储在 `static/uploads/avatars/` 目录
2. **数据库文件**: SQLite数据库文件位于 `instance/` 目录
3. **上传文件**: 排班表上传文件存储在 `instance/uploads/schedules/` 目录

## 故障排除

### 常见问题

1. **初始化失败**
   - 检查数据库连接
   - 确保所有依赖已安装
   - 查看错误日志

2. **用户登录失败**
   - 确认用户名和密码
   - 检查用户状态是否激活
   - 验证权限设置

3. **医生数据丢失**
   - 检查是否有数据库备份
   - 使用导出功能恢复数据
   - 重新运行初始化脚本

### 调试方法

```bash
# 测试初始化功能
python test_doctor_init.py

# 查看数据库信息
python reset_database.py
# 选择选项 5

# 检查数据完整性
python -c "
from app import create_app
from app.models import Doctor, User
app = create_app()
with app.app_context():
    print(f'医生数量: {Doctor.query.count()}')
    print(f'用户数量: {User.query.count()}')
"
```

## 更新日志

### v1.0.0 (2024-01-21)
- 初始版本发布
- 实现医生数据初始化功能
- 添加数据导出和重置功能
- 提供完整的测试和文档

## 技术支持

如遇到问题，请检查：
1. Python和依赖包版本
2. 数据库文件权限
3. 系统日志输出
4. 本说明文档的故障排除部分