# 排班表上传功能说明

## 功能概述

在排班管理界面中，新增了"上传排班表"功能，允许管理员通过上传Excel或CSV文件批量导入排班数据，同时支持实时预览和查看功能。

## 功能特点

### 1. 文件支持
- **Excel文件**: .xlsx, .xls 格式
- **CSV文件**: .csv 格式
- **自动识别列名**: 支持中文和英文列名

### 2. 年月选择
- 上传前必须选择对应的年月
- 系统会验证文件中的日期是否在选定的月份范围内
- 默认设置为下个月

### 3. 实时预览
- 上传前可以预览文件内容
- 最多显示前20条记录
- 显示文件解析状态和统计信息

### 4. 智能匹配
- 自动匹配医生姓名
- 验证科室和班次类型
- 支持未分配医生的排班

## 文件格式要求

### 必需列
| 中文列名 | 英文列名 | 说明 | 示例 |
|---------|---------|------|------|
| 日期 | date | 排班日期 | 2024-02-01 |
| 星期 | weekday | 星期几 | 星期四 |
| 班次 | shift | 班次类型 | 白班、中班、夜班、值班 |
| 时间 | time_range | 时间段 | 08:00-16:00 |
| 科室 | department | 工作科室 | 门诊、急诊、妇科、产科、儿科、筛查 |

### 可选列
| 中文列名 | 英文列名 | 说明 | 示例 |
|---------|---------|------|------|
| 医生姓名 | doctor_name, doctor, 姓名 | 负责医生 | 张三 |

### 数据格式要求

1. **日期格式**: YYYY-MM-DD (如: 2024-02-01)
2. **班次类型**: 白班、中班、夜班、值班等
3. **时间格式**: HH:MM-HH:MM (如: 08:00-16:00)
4. **科室**: 门诊、急诊、妇科、产科、儿科、筛查等
5. **医生姓名**: 必须与系统中医生姓名完全一致

## 文件示例

```csv
日期,星期,班次,时间,科室,医生姓名
2024-02-01,星期四,白班,08:00-16:00,门诊,张三
2024-02-01,星期四,中班,16:00-24:00,急诊,李四
2024-02-02,星期五,白班,08:00-16:00,门诊,王五
2024-02-02,星期五,夜班,24:00-08:00,急诊,
```

## 使用步骤

### 1. 访问上传功能
1. 登录系统（需要管理员权限）
2. 进入"排班管理"页面
3. 点击"上传排班表"按钮

### 2. 准备文件
1. 按照格式要求准备Excel或CSV文件
2. 确保所有必需列都存在
3. 检查日期格式和医生姓名

### 3. 上传文件
1. **选择年月**: 选择排班表对应的年月
2. **选择文件**: 点击"选择排班表文件"按钮
3. **预览文件**: 点击"预览文件"查看解析结果
4. **确认上传**: 点击"确认上传"导入数据

### 4. 查看结果
- 系统会显示上传进度和结果统计
- 成功/失败记录数
- 错误信息（如果有）
- 上传完成后自动刷新排班表

## 错误处理

### 常见错误类型

1. **文件格式错误**
   - 不支持的文件类型
   - 缺少必需的列
   - 文件损坏

2. **数据格式错误**
   - 日期格式不正确
   - 时间格式不正确
   - 空值数据

3. **匹配错误**
   - 找不到指定医生
   - 日期不在选定月份范围内

### 错误提示
- 系统会显示详细的错误信息
- 包括出错行号和具体原因
- 最多显示前10个错误

## 注意事项

1. **权限要求**: 只有管理员和超级管理员可以使用上传功能
2. **文件大小**: 建议单个文件不超过10MB
3. **数据覆盖**: 上传时会清理该月的现有排班数据
4. **医生匹配**: 医生姓名必须与系统中完全一致
5. **日期验证**: 只有选定月份内的数据会被导入

## 技术实现

### 后端依赖
- Flask: Web框架
- pandas: 数据处理
- openpyxl: Excel文件支持
- SQLAlchemy: 数据库操作

### 文件处理流程
1. 文件上传到临时目录
2. 使用pandas解析文件内容
3. 数据验证和清理
4. 医生姓名匹配
5. 数据库导入
6. 临时文件清理

### 安全措施
- 文件类型验证
- 文件名安全处理
- SQL注入防护
- 权限验证

## 更新日志

### v1.0.0 (2024-01-21)
- 初始版本发布
- 支持Excel和CSV文件上传
- 实现预览功能
- 添加错误处理和验证